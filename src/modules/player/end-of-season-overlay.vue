<template>
  <transition>
    <div class="end-of-season-container" :class="{ small: !isPlayerMaximized }">
      <h1 class="text">{{ endMessage }}</h1>

      <h2 v-if="!isFinalEpisode" class="text two-lines">
        The next episode airs in {{ nextEpisodeDistanceString }} <br />
        {{ nextEpisodeDateString }}
      </h2>

      <score v-if="listEntry" :media-id="listEntry.mediaId" />

      <div v-if="isFinalEpisode && sequels.length > 0" class="sequel-container">
        <h1 class="text">Sequel{{ sequels.length > 1 ? 's' : '' }}:</h1>

        <div v-for="sequel in sequels" :key="sequel.id" class="sequel">
          <anime-banner class="banner" :anime="sequel" link />
        </div>
      </div>
    </div>
  </transition>
</template>

<script lang="ts">
import { Component, Prop, Vue } from 'vue-property-decorator'
import { format, formatDistance } from 'date-fns'

import {
  AnimeViewNextAiringEpisode,
  PlayerAnimeListEntry,
} from '@/graphql/generated/types'

import { Required } from '@/decorators'
import { Sequel } from '@/state/app'

import CButton from '@/common/components/button.vue'
import AnimeBanner from '@/common/components/anime-banner.vue'
import Icon from '@/common/components/icon.vue'
import Score from '@/common/components/score.vue'

@Component({
  components: { Score, AnimeBanner, CButton, Icon },
})
export default class EndOfSeasonOverlay extends Vue {
  @Prop(Object) public listEntry!: PlayerAnimeListEntry | null
  @Required(Array) public sequels!: Sequel[]
  @Required(Number) public episodeNumber!: number
  @Prop(Number) public episodesInAnime!: number | null
  @Prop(Object)
  public nextAiringEpisode!: AnimeViewNextAiringEpisode | null
  @Required(Boolean) public isPlayerMaximized!: boolean

  public get isFinalEpisode() {
    if (this.episodesInAnime == null) return false

    return this.episodeNumber >= this.episodesInAnime
  }

  public get nextEpisodeDateString() {
    if (!this.nextAiringEpisode) return null

    return format(this.nextAiringEpisode.airingAt * 1000, 'iii do MMM - kk:mm')
  }

  public get nextEpisodeDistanceString() {
    if (!this.nextAiringEpisode) return null

    return formatDistance(new Date(), this.nextAiringEpisode.airingAt * 1000)
  }

  public get endMessage() {
    return `The end${this.isFinalEpisode ? '!' : ' for now!'}`
  }
}
</script>

<style scoped lang="scss">
@import '../../colors';

@keyframes expand {
  from {
    right: 100%;
  }
  to {
    right: 0;
  }
}

.end-of-season-container {
  position: absolute;
  top: 80px;
  left: 0;
  bottom: 65px;
  width: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  pointer-events: none;
  user-select: none;
  overflow: hidden;
  transition: top 0.5s, height 0.5s, transform 0.5s;

  & > * {
    transition: opacity 0.5s;
    flex-shrink: 0;
  }

  &.small {
    top: 50%;
    height: 25px;
    transform: translateY(-50%);
    justify-content: flex-start;

    & > *:not(.text) {
      transition: opacity 0s;
      opacity: 0;
    }
  }

  & .text {
    height: 35px;
    font-size: 1.25em;
    padding: 5px;
    overflow: hidden;
    font-family: 'Raleway', sans-serif;
    text-shadow: $outline;
    font-weight: 600 !important;
    margin: 0;
    filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.35));

    &.two-lines {
      height: 60px;
    }

    &.v-enter-active,
    &.v-leave-active {
      transition: 0.25s;
    }

    &.v-enter,
    &.v-leave-to {
      height: 0;
      padding: 0;
    }
  }

  & > .scores-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 50px;
    pointer-events: all;
    overflow: hidden;
    filter: drop-shadow(1px 2px 3px rgba(0, 0, 0, 0.5));
    transition: height 0.25s, opacity 0.25s;

    & > .score {
      position: relative;
      margin: 0 5px;
      height: 50px;
      width: 50px;
      cursor: pointer;
      pointer-events: all;
      transition: transform 0.15s;

      & > .icon {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
        fill: gold;
      }

      &:hover {
        transform: scale(1.1);
      }

      &:first-child {
        margin-left: 0;
      }
      &:last-child {
        margin-right: 0;
      }
    }
  }

  & > .sequel-container {
    & > .sequel {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      overflow: hidden;
      text-shadow: $outline !important;
      filter: drop-shadow(1px 2px 3px rgba(0, 0, 0, 0.5));

      & > .button {
        position: relative;
        pointer-events: all;
        padding: 0.35em 2em 0.5em;
        font-size: 1.25em;
        height: 45px;

        &.v-enter-active {
          transition: 0.5s;
        }

        &.v-leave-active {
          transition: 0.25s;
        }

        &.v-enter,
        &.v-leave-to {
          height: 0;
          padding: 0;
        }

        &.v-leave,
        &.v-enter-to {
          height: 45px;
          padding: 0.35em 2em 0.5em;
        }
      }

      & > .banner {
        width: 750px;
        max-width: 90%;
        pointer-events: all;
        overflow: hidden;
        border-radius: 5px;
        filter: drop-shadow(1px 2px 5px rgba(0, 0, 0, 0.5));
      }
    }
  }

  &.v-enter-active,
  &.v-leave-active {
    transition: transform 0.75s;
  }

  &.v-enter {
    transform: translateX(100%);
  }

  &.v-leave-to {
    transform: translateX(-150%);
  }
}
</style>
